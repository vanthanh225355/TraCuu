<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra c·ª©u Danh b·∫°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        body {
            padding: 20px;
        }

        .pagination {
            justify-content: center;
        }

        #loading {
            text-align: center;
            font-weight: bold;
            margin: 20px 0;
        }

        .active-btn {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2 class="mb-4">Tra c·ª©u Danh b·∫° </h2> <p>Dev a Th√†nh 0837000077</p>
        <div class="mb-3">
            <button class="btn btn-primary me-2" id="btnXa">Tra c·ª©u ƒë·ªãa ch·ªâ x√£ c≈© - m·ªõi</button>
            <button class="btn btn-secondary" id="btnCoQuan">Tra c·ª©u s·ªü ban ng√†nh</button>
        </div>

        <div class="d-flex justify-content-between mb-3">
            <input type="text" id="searchInput" class="form-control me-2" placeholder="Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm..."
                style="max-width: 100%;" />
            <button class="btn btn-warning" id="reloadBtn">T·∫£i l·∫°i cache</button>
        </div>

        <div id="loading" class="text-primary">üîÑ ƒêang t·∫£i d·ªØ li·ªáu...</div>

        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead class="table-dark" id="tableHeader"></thead>
                <tbody id="dataTable"></tbody>
            </table>
        </div>

        <nav>
            <ul class="pagination" id="pagination"></ul>
        </nav>
    </div>

    <script>
        const configs = {
            xa: {
                url: 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLiuEji73As42_wU4cTB39juEk5f1B60ylJ3cMwZmhElx652uZLmiwLkmCLNwUziyIRhjmqTKKm1Hfl3nrF64eacgmiXjACCZARgwR5E5d6-Q9OMHvFWzvad_gYFR4vwMMDpJGNDOoUHgDjGNCbkC6Tzq2ocphhMHTNcOs1cJ5oWzMkwcCICaIVt-qprLqeL5A5WKYXCpf-Yz7pN2aFJwg4tpbM_HgZ1TRilCvHX0JFplY4PJYxVwiv4omW3ZPBQsUFe-Z3VNzVKJxi_wmpIkrBThA1urehV3Jc5XQkVCM3ve6bKGRg&lib=MhxqNrrZq42rJ9E2tD4EYPkLJAn7ytpq1',
                cacheKey: 'xaDataCache',
                cacheTimeKey: 'xaDataCacheTime',
                header: `<tr><th>STT</th><th>T√™n c≈©</th><th>T√™n m·ªõi</th><th>Tr·ª• s·ªü</th></tr>`,
                parse: item => `<tr><td>{index}</td><td>${item.ten_cufull}</td><td>${item.ten_moifull}</td><td>${item.TruSo}</td></tr>`
            },
            coquan: {
                url: 'https://script.google.com/macros/s/AKfycbyy52_SAqRV-dvNsmyI2WcfZrQnYqg9n2iQM3UhAPdDhMrxtnQIonT4ak6aFnf8V8OWXQ/exec?sheet=CoQuan',
                cacheKey: 'coquanDataCache',
                cacheTimeKey: 'coquanCacheTime',
                header: `<tr><th>STT</th><th>T√™n</th><th>ƒê·ªãa ch·ªâ</th></tr>`,
                parse: item => `<tr><td>{index}</td><td>${item.Ten}</td><td>${item.DiaChi}</td></tr>`
            }
        };

        let currentConfig = configs.xa;
        let data = [], filteredData = [], currentPage = 1, rowsPerPage = 50;

        const searchInput = document.getElementById('searchInput');
        const reloadBtn = document.getElementById('reloadBtn');
        const loading = document.getElementById('loading');
        const dataTable = document.getElementById('dataTable');
        const pagination = document.getElementById('pagination');
        const tableHeader = document.getElementById('tableHeader');
        const btnXa = document.getElementById('btnXa');
        const btnCoQuan = document.getElementById('btnCoQuan');

        function removeVietnameseTones(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ƒë/g, "d").replace(/ƒê/g, "D");
        }

        function renderTable(page = 1) {
            dataTable.innerHTML = '';
            let start = (page - 1) * rowsPerPage;
            let paginatedData = filteredData.slice(start, start + rowsPerPage);
            paginatedData.forEach((item, index) => {
                let row = currentConfig.parse(item).replace('{index}', start + index + 1);
                dataTable.innerHTML += row;
            });
        }

        function renderPagination() {
            pagination.innerHTML = '';
            let totalPages = Math.ceil(filteredData.length / rowsPerPage);
            for (let i = 1; i <= totalPages; i++) {
                let li = document.createElement('li');
                li.className = 'page-item' + (i === currentPage ? ' active' : '');
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.addEventListener('click', function (e) {
                    e.preventDefault();
                    currentPage = i;
                    renderTable(currentPage);
                    renderPagination();
                });
                pagination.appendChild(li);
            }
        }

        function handleSearch() {
            let keyword = removeVietnameseTones(searchInput.value.toLowerCase().trim());
            let keywords = keyword.split(' ').filter(k => k !== '');
            if (keywords.length === 0) {
                filteredData = [...data];
            } else {
                filteredData = data.filter(item => {
                    let str = removeVietnameseTones(JSON.stringify(item).toLowerCase());
                    return keywords.every(k => str.includes(k));
                });
            }
            currentPage = 1;
            renderTable(currentPage);
            renderPagination();
        }

        async function fetchData() {
            loading.textContent = 'üîÑ ƒêang t·∫£i d·ªØ li·ªáu...';
            loading.style.display = 'block';
            const res = await fetch(currentConfig.url);
            const json = await res.json();
            loading.style.display = 'none';
            return json.data || json;
        }

        async function loadData() {
            loading.style.display = 'block';
            let cacheTime = localStorage.getItem(currentConfig.cacheTimeKey);
            let cacheData = localStorage.getItem(currentConfig.cacheKey);
            let now = new Date();
            if (cacheData && cacheTime) {
                let diffDays = (now - new Date(cacheTime)) / (1000 * 60 * 60 * 24);
                if (diffDays < 30) {
                    let decompressed = LZString.decompress(cacheData);
                    data = JSON.parse(decompressed);
                    filteredData = [...data];
                    loading.textContent = '‚úÖ D·ªØ li·ªáu ƒë∆∞·ª£c t·∫£i t·ª´ cache';
                    setTimeout(() => loading.style.display = 'none', 1000);
                    renderTable(currentPage);
                    renderPagination();
                    return;
                }
            }
            try {
                const freshData = await fetchData();
                data = freshData;
                filteredData = [...data];
                let compressed = LZString.compress(JSON.stringify(data));
                localStorage.setItem(currentConfig.cacheKey, compressed);
                localStorage.setItem(currentConfig.cacheTimeKey, now.toISOString());
                renderTable(currentPage);
                renderPagination();
                loading.textContent = '‚úÖ D·ªØ li·ªáu m·ªõi ƒë√£ l∆∞u';
                setTimeout(() => loading.style.display = 'none', 1000);
            } catch (error) {
                console.error('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
                loading.textContent = '‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu';
            }
        }

        function switchMode(mode) {
            if (mode === 'xa') {
                currentConfig = configs.xa;
                btnXa.classList.add('btn-primary');
                btnXa.classList.remove('btn-secondary');
                btnCoQuan.classList.add('btn-secondary');
                btnCoQuan.classList.remove('btn-primary');
            } else {
                currentConfig = configs.coquan;
                btnCoQuan.classList.add('btn-primary');
                btnCoQuan.classList.remove('btn-secondary');
                btnXa.classList.add('btn-secondary');
                btnXa.classList.remove('btn-primary');
            }
            tableHeader.innerHTML = currentConfig.header;
            loadData();
        }

        searchInput.addEventListener('input', handleSearch);

        reloadBtn.addEventListener('click', () => {
            localStorage.removeItem(currentConfig.cacheKey);
            localStorage.removeItem(currentConfig.cacheTimeKey);
            loadData();
        });

        btnXa.addEventListener('click', () => switchMode('xa'));
        btnCoQuan.addEventListener('click', () => switchMode('coquan'));

        // M·∫∑c ƒë·ªãnh load b·∫£ng X√£
        switchMode('xa');
    </script>
</body>

</html>
